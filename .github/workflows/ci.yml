# ── CI Pipeline ──────────────────────────────────────────────────────────────
# Triggers: every push and pull-request to main / develop.
# Jobs (run in parallel where possible):
#   lint      – Black, isort, Flake8
#   typecheck – mypy (src/ only)
#   security  – Bandit static security scan
#   test      – pytest + coverage report (runs after the three above pass)

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs for the same branch/PR to save CI minutes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.10"

jobs:
  # ── 1. Code Style & Linting ───────────────────────────────────────────────
  lint:
    name: "Lint (Black · isort · Flake8)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies (with dev extras)
        run: uv sync --all-extras

      - name: Black – check formatting
        run: uv run black --check src/ tests/ scripts/

      - name: isort – check import order
        run: uv run isort --check-only src/ tests/ scripts/

      - name: Flake8 – check style & common bugs
        run: uv run flake8 src/ tests/ scripts/

  # ── 2. Static Type Checking ────────────────────────────────────────────────
  typecheck:
    name: "Type Check (mypy)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies (with dev extras)
        run: uv sync --all-extras

      - name: mypy – type-check src/
        run: uv run mypy src/ --ignore-missing-imports --no-strict-optional

  # ── 3. Security Scan ──────────────────────────────────────────────────────
  security:
    name: "Security Scan (Bandit)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies (with dev extras)
        run: uv sync --all-extras

      - name: Bandit – security scan of src/
        run: uv run bandit -c pyproject.toml -r src/

  # ── 4. Tests & Coverage ────────────────────────────────────────────────────
  # Runs only after all quality gates above have passed.
  test:
    name: "Tests & Coverage (pytest)"
    runs-on: ubuntu-latest
    needs: [lint, typecheck, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Create required directories
        run: mkdir -p data/raw data/processed outputs/figures models logs

      - name: Run pytest with coverage
        env:
          # Provide a dummy DATA_PATH so the pipeline settings don't fail
          DATA_PATH: data/raw
        run: |
          uv run pytest tests/ \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=35

      - name: Upload coverage report to Codecov
        uses: codecov/codecov-action@v4
        # Only upload from push events (not PRs from forks)
        if: github.event_name == 'push'
        with:
          files: coverage.xml
          fail_ci_if_error: false          # Don't break CI if Codecov is down
          token: ${{ secrets.CODECOV_TOKEN }}
